<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Family Command Center â€” Chores on Calendar</title>
<meta name="theme-color" content="#ffffff" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('sw.js').catch(console.warn);
    });
  }
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { firebaseConfig, HOUSEHOLD_ID } from "./firebase-config.js";
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  // Expose Firestore and helper functions globally so inline script can access them
  window.__fcc = {
    db,
    HOUSEHOLD_ID,
    firestore: { doc, getDoc, setDoc, onSnapshot }
  };
</script>
<style>
:root { --bg:#fff; --fg:#111; --muted:#6b7280; --card:#f3f4f6; --primary:#2563eb; --danger:#dc2626; --grid:#e5e7eb; --ok:#16a34a; --shadow:0 2px 10px rgba(0,0,0,.06);
  /* additional accent colours for nav buttons */
  --color-calendar: var(--primary);
  --color-chores: #16a34a; /* green */
  --color-lists: #8b5cf6;  /* purple */
  --color-meals: #ea580c;  /* orange */
 }
@media (prefers-color-scheme: dark){ :root{ --bg:#0b0e14; --fg:#e5e7eb; --muted:#9aa0a6; --card:#171b22; --grid:#222936; } }
:root[data-theme="dark"]{ --bg:#0b0e14; --fg:#e5e7eb; --muted:#9aa0a6; --card:#171b22; --grid:#222936; }
:root[data-theme="light"]{ --bg:#fff; --fg:#111; --muted:#6b7280; --card:#f3f4f6; --grid:#e5e7eb; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg);line-height:1.4}
.app-header{position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--grid); padding:.75rem 1rem; display:grid; grid-template-columns:1fr auto; align-items:center; gap:1rem;}
h1{margin:0;font-size:1.15rem}
.settings-btn{background:var(--card); border:1px solid var(--grid); padding:.5rem .75rem; border-radius:.5rem; cursor:pointer}
.settings-btn:hover{outline:2px solid var(--primary); outline-offset:1px}
.app{display:grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 64px);} 
@media (max-width: 900px){ .app{ grid-template-columns: 72px 1fr; } .nav .label{ display:none; } }
.nav{border-right:1px solid var(--grid); background:var(--bg); padding:.75rem; display:flex; flex-direction:column; gap:.75rem;}
.nav h2{ font-size:.9rem; color:var(--muted); margin:.25rem .25rem; }
.nav-btn{display:flex; align-items:center; gap:.75rem; width:100%; background:var(--card); border:1px solid var(--grid); padding:1rem .9rem; border-radius:.8rem; cursor:pointer; font-weight:600; text-align:left;}
.nav-btn .dot{ width:.9rem; height:.9rem; border-radius:50%; background:var(--primary); opacity:.85; }
.nav-btn:hover{ outline:2px solid var(--primary); outline-offset:1px; }
/* Assign per-section colours to nav buttons and their active states */
.nav-btn[data-section="calendar"] .dot{ background:var(--color-calendar); }
.nav-btn[data-section="chores"] .dot{ background:var(--color-chores); }
.nav-btn[data-section="lists"] .dot{ background:var(--color-lists); }
.nav-btn[data-section="meals"] .dot{ background:var(--color-meals); }

.nav-btn[data-section="calendar"]:hover{ outline:2px solid var(--color-calendar); }
.nav-btn[data-section="chores"]:hover{ outline:2px solid var(--color-chores); }
.nav-btn[data-section="lists"]:hover{ outline:2px solid var(--color-lists); }
.nav-btn[data-section="meals"]:hover{ outline:2px solid var(--color-meals); }

/* Active state backgrounds and text colour */
.nav-btn[data-section="calendar"].active{ border-color:transparent; color:#fff; background:var(--color-calendar); }
.nav-btn[data-section="chores"].active{ border-color:transparent; color:#fff; background:var(--color-chores); }
.nav-btn[data-section="lists"].active{ border-color:transparent; color:#fff; background:var(--color-lists); }
.nav-btn[data-section="meals"].active{ border-color:transparent; color:#fff; background:var(--color-meals); }
main{ padding:1rem; max-width:1400px; position:relative; z-index:1; }
.section{ display:none; }
.section.active{ display:block; }
.row{ display:flex; gap:.5rem; }
.wrap{ flex-wrap:wrap; }
.align-center{ align-items:center; }
.space-between{ justify-content:space-between; }
.gap{ gap:.5rem; }
.mono{ font-variant-numeric: tabular-nums; }
.muted{ color:var(--muted); }
.mini{ padding:.25rem .5rem; font-size:.85rem; }
button,input,select,textarea,.file-label{
  font:inherit; color:inherit; background:var(--card); border:1px solid var(--grid);
  padding:.5rem .6rem; border-radius:.5rem; max-width:100%;
}
button{ cursor:pointer; touch-action:manipulation; -webkit-tap-highlight-color:transparent; }
button.primary{ background:var(--primary); color:#fff; border-color:transparent; }
button.secondary{ background:transparent; }
button.danger{ background:var(--danger); color:#fff; border-color:transparent; }
.file-label{ display:inline-flex; align-items:center; gap:.5rem; cursor:pointer; }
.calendar-layout{ display:grid; grid-template-columns: minmax(520px, 1fr) 380px; gap:1rem; }
@media (max-width: 900px){ .calendar-layout{ grid-template-columns: 1fr; } }
.calendar-grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:.25rem; border-top:1px solid var(--grid); border-left:1px solid var(--grid); margin-top:.5rem; }
.calendar-grid .cell{ border-right:1px solid var(--grid); border-bottom:1px solid var(--grid); min-height:92px; padding:.25rem; display:flex; flex-direction:column; gap:.25rem; }
.calendar-grid .dow{ background:var(--card); font-weight:600; text-align:center; padding:.5rem 0; }
.calendar-grid .date{ font-size:.9rem; color:var(--muted); }
.event-pill{
  border-radius:.45rem; padding:.15rem .4rem;
  background:#1111; border:1px solid #0002; font-size:.85rem;
  display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; box-shadow:var(--shadow);
}
.event-pill:hover{ transform: translateY(-1px); }
.pill-icon{ font-size:.95rem; line-height:1; }
.event-pill.chore{ border-style:dashed; }
.day-agenda{
  background:var(--card); border:1px solid var(--grid); border-radius:.75rem; padding:.75rem; box-shadow:var(--shadow);
  position:sticky; top:88px; height: fit-content;
}
.agenda-list{ list-style:none; padding:0; margin:.5rem 0 0; display:grid; gap:.5rem; }
.agenda-item{ display:flex; justify-content:space-between; align-items:center; background:var(--bg); border:1px solid var(--grid); padding:.5rem .6rem; border-radius:.6rem; }
.badge{ font-size:.75rem; padding:.15rem .4rem; border:1px solid var(--grid); border-radius:999px; background:var(--card); }
.card-list{ list-style:none; padding:0; margin:.5rem 0; display:grid; gap:.5rem; }
.card{ background:var(--card); border:1px solid var(--grid); border-radius:.75rem; padding:.75rem; box-shadow:var(--shadow); display:grid; gap:.35rem; }
.card.completed{ background: color-mix(in srgb, var(--ok) 16%, var(--card)); border-color: color-mix(in srgb, var(--ok) 60%, var(--grid)); }
.meal-grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:.5rem; }
.meal-day{ background:var(--card); border:1px solid var(--grid); border-radius:.5rem; overflow:hidden; }
.meal-day header{ padding:.5rem; font-weight:600; border-bottom:1px solid var(--grid); display:grid; grid-template-columns:1fr auto; align-items:center; }
.meal-day header .quick{ display:flex; gap:.25rem; }
.meal-slot{ padding:.5rem; border-bottom:1px dashed var(--grid); }
.meal-slot:last-child{ border-bottom:0; }
.meal-slot h4{ margin:0 0 .25rem; font-size:.95rem; }
.meal-slot .ingredients{ color:var(--muted); font-size:.9rem; }
.settings-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:1rem; }
.box{ background:var(--card); border:1px solid var(--grid); border-radius:.75rem; padding:.75rem; box-shadow:var(--shadow); min-width:0; }
.member-list{ list-style:none; padding:0; margin:.5rem 0 0; display:grid; gap:.5rem; }
.member-row{ display:flex; flex-wrap:wrap; align-items:center; gap:.5rem; }
.member-chip{ display:inline-flex; align-items:center; gap:.4rem; border:1px solid var(--grid); padding:.25rem .5rem; border-radius:999px; }
.member-row input[type="color"]{ width:42px; height:32px; padding:0; border-radius:.5rem; }
.file-label input{ display:none; }
.modal::backdrop{ background:rgba(0,0,0,.4); }
.modal{ border:none; border-radius:.75rem; padding:0; background:var(--card); color:var(--fg); }
.modal-form{ padding:1rem; min-width:min(90vw,540px); display:grid; gap:.5rem; background:transparent; }
.recipe-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:.5rem; max-height: 220px; overflow:auto; }
.recipe-chip{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.5rem .6rem; border:1px solid var(--grid); background:var(--bg); border-radius:.6rem; cursor:pointer; }
.recipe-chip:hover{ outline:2px solid var(--primary); outline-offset:2px; }
.recipe-chip small{ color:var(--muted); }
.search{ width:100%; }
#confettiCanvas{ position:fixed; inset:0; pointer-events:none !important; z-index:9999; }
@media (max-width: 900px){
  .meal-grid{ grid-template-columns: 1fr; }
  .calendar-grid .cell{ min-height:70px; }
}
/* Added styles for profile pills, selected calendar cell, and quick buttons */
.profile-pills{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.25rem; }
.profile-pill{ display:flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border:1px solid var(--grid); border-radius:999px; cursor:pointer; font-size:.85rem; background:var(--card); }
.profile-pill .dot{ width:.75rem; height:.75rem; border-radius:50%; }
.profile-pill.active{ border-color:var(--primary); background:color-mix(in srgb, var(--primary) 20%, var(--card)); color:var(--primary); font-weight:600; }
.calendar-grid .cell.selected{ background:color-mix(in srgb, var(--primary) 10%, var(--bg)); border:2px solid var(--primary); border-radius:.5rem; }
.calendar-grid .cell.selected .date{ font-weight:700; color:var(--primary); }
.quick-buttons{ display:flex; flex-wrap:wrap; gap:.25rem; margin-top:.5rem; }
.quick-buttons button{ font-size:.75rem; padding:.25rem .5rem; }
/* Make custom quick buttons larger for prominence */
.quick-buttons .custom-btn{
  font-size:.85rem;
  padding:.35rem .7rem;
}
.member-chip.active{ border-color:var(--primary); color:var(--primary); font-weight:600; background:color-mix(in srgb, var(--primary) 10%, var(--card)); }
/* Styles for custom button configuration list */
/* Use a responsive grid for each custom button row.  Each input wraps neatly when space is constrained. */
.custom-buttons-list .custom-row{
  display:grid;
  /* Each cell spans at least 140px and grows to fill available space; auto-fit wraps items to new rows as needed. */
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap:.5rem;
  margin-bottom:.5rem;
  align-items:flex-start;
}
/* Individual labels in the custom button editor */
.custom-buttons-list .custom-row label{
  display:flex;
  flex-direction:column;
  font-size:.85rem;
}
/* Ensure the remove button stays compact and does not stretch */
.custom-buttons-list .custom-row .remove-btn{
  justify-self:start;
  align-self:center;
  white-space:nowrap;
}
/* Generic label styles within custom-buttons-list */
.custom-buttons-list label{
  display:flex;
  flex-direction:column;
  font-size:.85rem;
}
.custom-buttons-list input[type="text"]{ flex:1; }
</style>
</head>
<body>
  <header class="app-header">
    <h1>Family Command Center</h1>
    <button id="openSettings" class="settings-btn" aria-controls="settings" aria-expanded="false" onclick="setActive('settings')">Settings</button>
  </header>

  <canvas id="confettiCanvas"></canvas>

  <div class="app">
    <aside class="nav" role="navigation" aria-label="Primary">
      <h2>Navigate</h2>
      <button class="nav-btn active" data-section="calendar" onclick="setActive('calendar')">
        <span class="dot"></span><span class="label">Calendar</span>
      </button>
      <button class="nav-btn" data-section="chores" onclick="setActive('chores')">
        <span class="dot"></span><span class="label">Chores</span>
      </button>
      <button class="nav-btn" data-section="lists" onclick="setActive('lists')">
        <span class="dot"></span><span class="label">Lists</span>
      </button>
      <button class="nav-btn" data-section="meals" onclick="setActive('meals')">
        <span class="dot"></span><span class="label">Meal Planner</span>
      </button>
    </aside>

    <main>
      <section id="calendar" class="section active" role="region" aria-labelledby="Calendar">
        <div class="calendar-layout">
          <div>
            <div class="row space-between align-center">
              <div class="row align-center gap">
                <button id="prevMonth" aria-label="Previous month">â—€</button>
                <h2 id="monthLabel"></h2>
                <button id="nextMonth" aria-label="Next month">â–¶</button>
              </div>
              <div class="row align-center gap">
                <label> Member:
                  <select id="memberFilter"></select>
                </label>
                <!-- Profile pills for quick member switching -->
                <div id="profilePills" class="profile-pills"></div>
                <button id="todayBtn">Today</button>
                <button id="addEventBtn">+ Event</button>
              </div>
            </div>
            <div id="calendarGrid" class="calendar-grid" aria-label="Month grid" role="grid"></div>
          </div>

          <aside class="day-agenda">
            <div class="row space-between align-center">
              <h3 id="agendaHeading" style="margin:0"></h3>
              <button id="agendaAddBtn" class="mini">+ Event</button>
            </div>
            <div class="muted" id="agendaDateLabel"></div>
            <!-- Quick buttons for selected day -->
            <div id="quickButtons" class="quick-buttons"></div>
            <ul id="agendaList" class="agenda-list"></ul>
          </aside>
        </div>
      </section>

      <section id="chores" class="section" role="region" aria-labelledby="Chores">
        <div class="panel-header">
          <h2>Chore Board</h2>
          <button id="addChoreBtn">+ Chore</button>
        </div>
        <div class="filters row gap">
          <label>Assignee:
            <select id="choreAssigneeFilter"></select>
          </label>
          <label>Status:
            <select id="choreStatusFilter">
              <option value="all">All</option>
              <option value="open">Open</option>
              <option value="done">Done</option>
            </select>
          </label>
        </div>
        <!-- Profile pills for quick member switching within chores -->
        <div id="profilePillsChores" class="profile-pills"></div>
        <ul id="choreList" class="card-list"></ul>
      </section>

      <section id="lists" class="section" role="region" aria-labelledby="Lists">
        <div class="row wrap gap">
          <div class="list-col" style="flex:1 1 380px; min-width:280px;">
            <div class="panel-header">
              <h2>Groceries</h2>
              <button data-list="groceries" class="addListItemBtn">+ Item</button>
            </div>
            <ul id="groceriesList" class="card-list"></ul>
          </div>
          <div class="list-col" style="flex:1 1 380px; min-width:280px;">
            <div class="panel-header">
              <h2>To-Dos</h2>
              <button data-list="todos" class="addListItemBtn">+ Item</button>
            </div>
            <ul id="todosList" class="card-list"></ul>
          </div>
        </div>
      </section>

      <section id="meals" class="section" role="region" aria-labelledby="Meal Planner">
        <div class="panel-header">
          <h2>Weekly Meal Planner</h2>
          <div class="row align-center gap">
            <button id="prevWeek" aria-label="Previous week">â—€</button>
            <span id="weekLabel" class="mono"></span>
            <button id="nextWeek" aria-label="Next week">â–¶</button>
            <button id="addMealBtn">+ Meal</button>
            <button id="sendIngredientsBtn">Send ingredients to Groceries</button>
          </div>
        </div>
        <div id="mealGrid" class="meal-grid"></div>
      </section>

      <section id="settings" class="section" role="region" aria-labelledby="Settings">
        <h2>Settings</h2>
        <div class="settings-grid">
          <div class="box">
            <h3>Family Members</h3>
            <ul id="memberList" class="member-list"></ul>
            <button id="addMemberBtn">+ Member</button>
          </div>
          <div class="box">
            <h3>Theme</h3>
            <div class="row gap">
              <button data-theme="light" class="themeBtn">Light</button>
              <button data-theme="dark" class="themeBtn">Dark</button>
              <button data-theme="auto" class="themeBtn">Auto</button>
            </div>
          </div>
          <div class="box">
            <h3>Backup</h3>
            <div class="row gap wrap">
              <button id="exportJsonBtn">Export JSON</button>
              <label class="file-label">Import JSON <input id="importJsonInput" type="file" accept="application/json" /></label>
              <button id="exportIcsBtn">Export .ics (events)</button>
            </div>
          </div>
          <div class="box">
            <h3>Recipes (Common Meals)</h3>
            <div class="row gap wrap"><button id="addRecipeBtn">+ Recipe</button></div>
            <ul id="recipeList" class="card-list"></ul>
          </div>
          <!-- Quick Buttons Customisation -->
          <div class="box">
            <h3>Quick Buttons</h3>
            <div id="customButtonsList" class="custom-buttons-list"></div>
            <small class="muted">Configure label, colour, and times for your quick action buttons. Use + Add Button to add more and Remove to delete. Changes save automatically.</small>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODALS -->
  <dialog id="eventModal" class="modal">
    <form method="dialog" id="eventForm" class="modal-form">
      <h3 id="eventModalTitle">New Event</h3>
      <input type="hidden" id="eventId" />
      <label>Title <input id="eventTitle" required /></label>
      <div class="row gap">
        <label>Start <input id="eventStart" type="datetime-local" required /></label>
        <label>End <input id="eventEnd" type="datetime-local" required /></label>
      </div>
      <label>Member
        <select id="eventMember"></select>
      </label>
      <label>Location <input id="eventLocation" placeholder="Optional" /></label>
      <label>Notes <textarea id="eventNotes" rows="3" placeholder="Optional"></textarea></label>
      <div class="row space-between">
        <button type="button" value="cancel" class="secondary" onclick="closeDialog('eventModal')">Cancel</button>
        <div class="row gap">
          <button id="deleteEventBtn" class="danger" type="button">Delete</button>
          <button id="saveEventBtn" value="default" class="primary" type="button">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="choreModal" class="modal">
    <form method="dialog" id="choreForm" class="modal-form">
      <h3 id="choreModalTitle">New Chore</h3>
      <input type="hidden" id="choreId" />
      <label>Title <input id="choreTitle" required /></label>
      <label>Assignee
        <select id="choreAssignee"></select>
      </label>
      <label>Due (optional) <input id="choreDue" type="date" /></label>
      <label>Repeats
        <select id="choreRepeat">
          <option value="none">Does not repeat</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </label>
      <div class="row space-between">
        <button type="button" value="cancel" class="secondary" onclick="closeDialog('choreModal')">Cancel</button>
        <div class="row gap">
          <button id="deleteChoreBtn" class="danger" type="button">Delete</button>
          <button id="saveChoreBtn" value="default" class="primary" type="button">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="listItemModal" class="modal">
    <form method="dialog" id="listItemForm" class="modal-form">
      <h3 id="listItemModalTitle">New Item</h3>
      <input type="hidden" id="listType" />
      <input type="hidden" id="listItemId" />
      <label>Item <input id="listItemText" required /></label>
      <label>Quantity (optional) <input id="listItemQty" /></label>
      <div class="row space-between">
        <button type="button" value="cancel" class="secondary" onclick="closeDialog('listItemModal')">Cancel</button>
        <div class="row gap">
          <button id="deleteListItemBtn" class="danger" type="button">Delete</button>
          <button id="saveListItemBtn" value="default" class="primary" type="button">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <dialog id="mealModal" class="modal">
    <form method="dialog" id="mealForm" class="modal-form">
      <h3 id="mealModalTitle">Add Meal</h3>
      <input type="hidden" id="mealDate" />
      <label>Meal slot
        <select id="mealSlot">
          <option>Breakfast</option>
          <option>Lunch</option>
          <option selected>Dinner</option>
        </select>
      </label>

      <div class="row gap wrap">
        <input id="recipeSearch" class="search" placeholder="Search recipesâ€¦" />
      </div>
      <div id="topRecipes" class="recipe-grid"></div>

      <label>Recipe
        <select id="recipeSelect">
          <option value="">â€” Choose a recipe â€”</option>
        </select>
      </label>

      <label>Name <input id="mealName" required /></label>
      <label>Ingredients (comma separated)
        <textarea id="mealIngredients" rows="3" placeholder="e.g., pasta, tomatoes, basil"></textarea>
      </label>
      <div class="row space-between">
        <button type="button" value="cancel" class="secondary" onclick="closeDialog('mealModal')">Cancel</button>
        <div class="row gap">
          <button id="deleteMealBtn" class="danger" type="button">Clear</button>
          <button id="saveMealBtn" value="default" class="primary" type="button">Save</button>
        </div>
      </div>
    </form>
  </dialog>

<script>
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
function pad2(n){ return n<10 ? '0'+n : ''+n; }
function dateKeyLocal(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function parseDateOnlyLocal(s){ const [y,m,dd]=s.split('-').map(Number); const d=new Date(); d.setFullYear(y,m-1,dd); d.setHours(0,0,0,0); return d; }
function atMidnight(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(e.getDate()+6); return e; }
function toLocalInput(dtIso){ return dtIso ? dtIso.slice(0,16) : ''; }
function fromLocalInput(val){ return new Date(val).toISOString(); }
function byId(arr,id){ return arr.find(x=>x.id===id); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function hex2rgba(hex,a){ const c=hex.replace('#',''); const n=parseInt(c,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r}, ${g}, ${b}, ${a})`; }

const STORAGE_KEY = 'fcc:v2'; // bump version to avoid conflicting with older saves
const defaultData = () => ({
  members: [
    { id: uid(), name: 'Adam', color: '#ef4444' },
    { id: uid(), name: 'Marie', color: '#10b981' },
    { id: uid(), name: 'Daphne', color: '#6366f1' },
  ],
  events: [],
  chores: [],
  lists: { groceries: [], todos: [] },
  meals: {},
  settings: { theme: 'auto' },
  // default definitions for custom quick buttons (six slots)
  customButtons: [
    { label: 'Custom 1', color: '#fde047', startTime: '00:00', endTime: '23:59' },
    { label: 'Custom 2', color: '#fb7185', startTime: '00:00', endTime: '23:59' },
    { label: 'Custom 3', color: '#34d399', startTime: '00:00', endTime: '23:59' },
    { label: 'Custom 4', color: '#a78bfa', startTime: '00:00', endTime: '23:59' },
    { label: 'Custom 5', color: '#f472b6', startTime: '00:00', endTime: '23:59' },
    { label: 'Custom 6', color: '#4ade80', startTime: '00:00', endTime: '23:59' }
  ],
  recipes: [
    { id: uid(), name: "Three Cheese Pasta Bake",
      ingredients: ["cheddar cheese","mozzarella","parmesan","penne pasta","courgette","fresh tomatoes","tinned chopped tomatoes","basil","veg stock cube"] },
    { id: uid(), name: "Stir Fry with Beef",
      ingredients: ["beef strips","soy sauce","garlic","ginger","mixed vegetables","egg noodles","sesame oil"] },
    { id: uid(), name: "Stir Fry with Chicken",
      ingredients: ["chicken breast","soy sauce","garlic","ginger","mixed vegetables","egg noodles","sesame oil"] },
    { id: uid(), name: "Slow Cooker Beef Stew",
      ingredients: ["braising beef","onions","carrots","celery","potatoes","beef stock cube","tinned chopped tomatoes","bay leaf","thyme","flour"] },
    { id: uid(), name: "Slow Cooker Chicken Curry",
      ingredients: ["chicken thighs","onions","garlic","ginger","curry paste","coconut milk","tinned tomatoes","chicken stock cube","spinach"] },
    { id: uid(), name: "Slow Cooker Chili",
      ingredients: ["minced beef","kidney beans","onions","garlic","chili powder","cumin","tinned chopped tomatoes","beef stock cube","bell peppers"] },
    { id: uid(), name: "Shepherdâ€™s Pie",
      ingredients: ["minced lamb","potatoes","butter","milk","onion","carrot","peas","gravy granules","worcestershire sauce"] },
    { id: uid(), name: "Roast Chicken Dinner",
      ingredients: ["whole chicken","roasting potatoes","carrots","broccoli","stuffing mix","gravy granules"] },
    { id: uid(), name: "Homemade Pizza",
      ingredients: ["pizza dough","tomato puree","mozzarella","cheddar","parmesan","toppings of choice (ham, mushrooms, peppers)"] },
    { id: uid(), name: "Ready Made Pizza",
      ingredients: ["frozen pizza or chilled ready-made pizza"] },
    { id: uid(), name: "Chicken Nuggets, Chips & Beans",
      ingredients: ["frozen chicken nuggets","oven chips","baked beans"] },
    { id: uid(), name: "Fish and Chips",
      ingredients: ["white fish fillets","batter mix","potatoes","peas","tartar sauce"] },
    { id: uid(), name: "Cheese Omelette",
      ingredients: ["eggs","cheddar","butter","salt","pepper"] }
  ],
  recipeUsage: {} // recipeId -> count
});
function uid(){ return Math.random().toString(36).slice(2,10); }
// We'll initialize state asynchronously after loading from Firestore.
let state = null;
// Firestore realtime subscription and last write timestamp
let _unsub = null;
let _lastWrite = 0;
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultData();
    const parsed=JSON.parse(raw);
    if(!parsed.lists) parsed.lists={groceries:[],todos:[]};
    if(!parsed.meals) parsed.meals={};
    if(!parsed.settings) parsed.settings={theme:'auto'};
    if(!parsed.recipes) parsed.recipes=[];
    if(!parsed.recipeUsage) parsed.recipeUsage={};
    return parsed;
  }catch{ return defaultData(); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function ensureTheme(){
  const root=document.documentElement;
  state.settings.theme==='auto'?root.removeAttribute('data-theme'):root.setAttribute('data-theme',state.settings.theme);
}

// --- Firestore integration helpers ---
// Migrate parsed data to ensure all expected fields exist and set defaults for missing keys
function migrate(parsed){
  const p = parsed || {};
  if(!p.lists) p.lists = { groceries: [], todos: [] };
  if(!p.meals) p.meals = {};
  if(!p.settings) p.settings = { theme: 'auto' };
  if(!p.recipes) p.recipes = [];
  if(!p.recipeUsage) p.recipeUsage = {};
  // Provide default members if missing or empty
  if(!Array.isArray(p.members) || p.members.length === 0){
    p.members = defaultData().members;
  }
  if(!Array.isArray(p.events)) p.events = [];
  if(!Array.isArray(p.chores)) p.chores = [];
  // Provide default custom buttons if missing
  if(!Array.isArray(p.customButtons)) p.customButtons = defaultData().customButtons;
  // Ensure each custom button has startTime and endTime
  if(Array.isArray(p.customButtons)){
    p.customButtons = p.customButtons.map(btn => {
      // ensure label and colour exist, then times
      const out = { ...btn };
      if(out.startTime == null) out.startTime = '00:00';
      if(out.endTime == null) out.endTime = '23:59';
      return out;
    });
  }
  return p;
}

// Get a Firestore document reference for this household
function firestoreDoc(){
  const fcc = window.__fcc;
  return fcc && fcc.firestore.doc(fcc.db, 'households', fcc.HOUSEHOLD_ID);
}

// Load state from Firestore with localStorage fallback and realtime updates
async function loadState(){
  let base = null;
  try{ base = JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch{}
  if(!base) base = defaultData();
  state = migrate(base);
  try{
    const fcc = window.__fcc;
    if(!fcc?.db) return;
    const ref = firestoreDoc();
    const snap = await fcc.firestore.getDoc(ref);
    if(snap.exists()){
      state = migrate(snap.data());
    } else {
      await fcc.firestore.setDoc(ref, state, { merge: true });
    }
    // Clean up existing listener if any
    if(_unsub) _unsub();
    // Subscribe to realtime updates
    _unsub = fcc.firestore.onSnapshot(ref, (docSnap) => {
      // Ignore updates immediately after our own writes to avoid thrashing
      if(Date.now() - _lastWrite < 400) return;
      if(docSnap.exists()){
        state = migrate(docSnap.data());
        ensureTheme();
        // Re-render all views when remote state changes
        renderCalendar(); renderChores(); renderLists(); renderMeals(); renderSettings(); renderProfilePills(); renderQuickButtons();
      }
    });
  }catch(e){
    console.warn('Firestore load failed, staying local only', e);
  }
}

// Save state to localStorage and Firestore
function saveState(){
  // Always keep a local backup
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{}
  try{
    const fcc = window.__fcc;
    if(!fcc?.db) return;
    _lastWrite = Date.now();
    return fcc.firestore.setDoc(firestoreDoc(), state, { merge: true });
  }catch(e){
    console.warn('Firestore save failed (using local only):', e);
  }
}

const confettiCanvas = $('#confettiCanvas'); const ctx = confettiCanvas.getContext('2d');
function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas); resizeCanvas();
function confettiBurst(x, y){
  const parts = Array.from({length: 80}, ()=> ({
    x, y, vx: (Math.random()*4-2)*3, vy: (Math.random()*-3-2)*3,
    size: Math.random()*4+2, life: Math.random()*50+40,
    color: `hsl(${Math.random()*360}, 90%, 60%)`
  }));
  let frame=0;
  function tick(){
    ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    parts.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--;
      ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size);
    });
    frame++;
    if (parts.some(p=>p.life>0) && frame < 180) requestAnimationFrame(tick);
    else ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
  }
  tick();
}

function setActive(id){
  const ids=['calendar','chores','lists','meals','settings'];
  ids.forEach(sec => {
    const el = document.getElementById(sec);
    if(el) el.classList.toggle('active', sec===id);
    const btn = document.querySelector(`.nav-btn[data-section="${sec}"]`);
    if(btn) btn.classList.toggle('active', sec===id);
  });
  if(id==='calendar') renderCalendar();
  if(id==='chores') renderChores();
  if(id==='lists') renderLists();
  if(id==='meals') renderMeals();
  if(id==='settings') renderSettings();
}
function closeDialog(id){ const d=document.getElementById(id); if(d?.open) d.close(); }

let calCursor = atMidnight(new Date());
let agendaSelectedKey = dateKeyLocal(new Date());
// New variable to track active profile (selected member)
let selectedProfileId = 'all';

$('#prevMonth').addEventListener('click', ()=>{ calCursor.setMonth(calCursor.getMonth()-1); renderCalendar(); });
$('#nextMonth').addEventListener('click', ()=>{ calCursor.setMonth(calCursor.getMonth()+1); renderCalendar(); });
$('#todayBtn').addEventListener('click', ()=>{ calCursor = atMidnight(new Date()); agendaSelectedKey = dateKeyLocal(new Date()); renderCalendar(); renderAgenda(); renderProfilePills(); renderQuickButtons(); });
// Updated add event button to prefill selected day and member
$('#addEventBtn').addEventListener('click', ()=>openEventModal(undefined, agendaSelectedKey, selectedProfileId));
$('#agendaAddBtn').addEventListener('click', ()=>openEventModal(undefined, agendaSelectedKey, selectedProfileId));

function renderProfilePills(){
  // Render profile pills in all containers with class 'profile-pills'
  const containers = document.querySelectorAll('.profile-pills');
  if(!containers || containers.length === 0) return;
  const members = [{id:'all', name:'All', color:'#6b7280'}, ...state.members];
  containers.forEach(container => {
    container.innerHTML = '';
    members.forEach(m => {
      const pill = document.createElement('div');
      pill.className = 'profile-pill';
      pill.dataset.memberId = m.id;
      if(m.id === selectedProfileId) pill.classList.add('active');
      pill.innerHTML = `<span class="dot" style="background:${m.color};"></span><span>${escapeHtml(m.name)}</span>`;
      pill.addEventListener('click', ()=>{
        selectedProfileId = m.id;
        // sync dropdown
        const memberFilter = $('#memberFilter');
        if(memberFilter) memberFilter.value = m.id;
        renderCalendar();
        renderAgenda();
        renderProfilePills();
        renderQuickButtons();
        renderChores();
        highlightMemberChips();
      });
      container.appendChild(pill);
    });
  });
}

function highlightMemberChips(){
  // highlight any member chips to reflect selected profile
  $$('.member-chip').forEach(chip=>{
    const id = chip.dataset.memberId || chip.getAttribute('data-member-id');
    chip.classList.toggle('active', id === selectedProfileId);
  });
}

function renderCalendar(){
  // Ensure drop-down matches selected profile
  const memberFilter = $('#memberFilter');
  memberFilter.innerHTML = '<option value="all">All members</option>' + state.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  if(!memberFilter.value) memberFilter.value = selectedProfileId;
  memberFilter.value = selectedProfileId;
  memberFilter.onchange = () => {
    selectedProfileId = memberFilter.value;
    renderCalendar();
    renderAgenda();
    renderProfilePills();
    renderQuickButtons();
    highlightMemberChips();
  };

  $('#monthLabel').textContent = calCursor.toLocaleDateString(undefined,{month:'long',year:'numeric'});
  const grid=$('#calendarGrid'); grid.innerHTML='';
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{ const c=document.createElement('div'); c.className='cell dow'; c.textContent=d; grid.appendChild(c); });

  const first=new Date(calCursor.getFullYear(), calCursor.getMonth(), 1);
  const start=startOfWeek(first);
  const nextMonth=new Date(calCursor.getFullYear(), calCursor.getMonth()+1, 1);
  const lastDate=new Date(nextMonth - 1);
  const end=endOfWeek(lastDate);

  for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
    const cell=document.createElement('div'); cell.className='cell';
    const dateLabel=document.createElement('div'); dateLabel.className='date';
    const key = dateKeyLocal(d);
    dateLabel.textContent = d.getMonth()===calCursor.getMonth()? d.getDate() : '';
    cell.appendChild(dateLabel);

    // highlight selected day
    if (key === agendaSelectedKey) {
      cell.classList.add('selected');
    }

    const memberId=memberFilter.value || 'all';

    const dayEvents=state.events
      .filter(e => e.start.slice(0,10) <= key && e.end.slice(0,10) >= key)
      .filter(e => memberId==='all' ? true : e.memberId===memberId)
      .sort((a,b)=> a.start.localeCompare(b.start));

    dayEvents.forEach(e=>{
      const m=byId(state.members,e.memberId) || {color:'#999', name:''};
      // choose colour: prefer event-specific colour (for custom buttons), else use member colour
      const colour = e.color || m.color;
      const pill=document.createElement('div'); pill.className='event-pill';
      pill.style.borderColor = colour;
      pill.style.boxShadow = 'inset 0 0 0 999px ' + hex2rgba(colour, .14);
      const time=new Date(e.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      pill.innerHTML=`<span class="dot" style="background:${colour};width:.6rem;height:.6rem;border-radius:50%"></span><span>${time} ${escapeHtml(e.title)}</span>`;
      pill.title=(m.name?`[${m.name}] `:'')+e.title;
      pill.addEventListener('click',()=>openEventModal(e.id));
      cell.appendChild(pill);
    });

    const dayChores = state.chores
      .filter(c => c.due === key && !c.done)
      .filter(c => memberId==='all' ? true : c.assignee===memberId);

    dayChores.forEach(c=>{
      const m=byId(state.members,c.assignee) || {color:'#999', name:''};
      const pill=document.createElement('div'); pill.className='event-pill chore';
      pill.style.borderColor=m.color; pill.style.boxShadow='inset 0 0 0 999px '+hex2rgba(m.color,.10);
      pill.innerHTML=`<span class="pill-icon">ðŸ§¹</span><span>${escapeHtml(c.title)}</span>`;
      pill.title=(m.name?`[${m.name}] `:'')+c.title+' (chore)';
      pill.addEventListener('click',()=>openChoreModal(c.id));
      cell.appendChild(pill);
    });

    cell.addEventListener('click', ()=>{ agendaSelectedKey = key; renderAgenda(); renderCalendar(); });
    cell.addEventListener('dblclick',()=>openEventModal(undefined, key, selectedProfileId));
    grid.appendChild(cell);
  }

  renderAgenda();
  renderProfilePills();
  renderQuickButtons();
}

function renderAgenda(){
  const label = $('#agendaDateLabel');
  const list = $('#agendaList');
  const date = parseDateOnlyLocal(agendaSelectedKey);
  const memberId = $('#memberFilter').value || 'all';
  label.textContent = date.toLocaleDateString(undefined,{weekday:'long', day:'numeric', month:'long', year:'numeric'});

  // Set heading relative to today
  const headingEl = $('#agendaHeading');
  if(headingEl){
    const today = atMidnight(new Date());
    const sel = atMidnight(date);
    const diffDays = Math.round((sel - today)/(1000*60*60*24));
    let headingText;
    if(diffDays === 0) headingText = 'Today';
    else if(diffDays === 1) headingText = 'Tomorrow';
    else if(diffDays === -1) headingText = 'Yesterday';
    else if(diffDays > 1) headingText = `In ${diffDays} days`;
    else headingText = `${Math.abs(diffDays)} days ago`;
    headingEl.textContent = headingText;
  }

  const events = state.events
    .filter(e => e.start.slice(0,10) <= agendaSelectedKey && e.end.slice(0,10) >= agendaSelectedKey)
    .filter(e => memberId==='all' ? true : e.memberId === memberId)
    .sort((a,b)=> a.start.localeCompare(b.start));

  const chores = state.chores
    .filter(c => c.due === agendaSelectedKey && !c.done)
    .filter(c => memberId==='all' ? true : c.assignee === memberId);

  list.innerHTML = '';
  if (!events.length && !chores.length){
    const li = document.createElement('li'); li.className='agenda-item';
    li.innerHTML='<span class="muted">Nothing scheduled</span><span></span>';
    list.appendChild(li);
    renderQuickButtons();
    return;
  }

  events.forEach(e=>{
    const time = new Date(e.start).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const li=document.createElement('li'); li.className='agenda-item';
    li.innerHTML = `<span><strong>${time}</strong> â€” ${escapeHtml(e.title)}</span><button class="mini secondary">Open</button>`;
    li.querySelector('button').addEventListener('click', ()=>openEventModal(e.id));
    list.appendChild(li);
  });
  chores.forEach(c=>{
    const m=byId(state.members,c.assignee);
    const li=document.createElement('li'); li.className='agenda-item';
    li.innerHTML = `<span>ðŸ§¹ ${escapeHtml(c.title)} ${m?`<span class="badge">${escapeHtml(m.name)}</span>`:''}</span>
                    <button class="mini secondary">Open</button>`;
    li.querySelector('button').addEventListener('click', ()=>openChoreModal(c.id));
    list.appendChild(li);
  });
  renderQuickButtons();
}

function renderQuickButtons(){
  const container = $('#quickButtons');
  if(!container) return;
  container.innerHTML = '';
  const dateKey = agendaSelectedKey;
  const memberId = selectedProfileId;
  // Event quick button
  const btnEvent = document.createElement('button');
  btnEvent.className = 'mini';
  btnEvent.textContent = '+ Event';
  btnEvent.addEventListener('click', ()=>openEventModal(undefined, dateKey, memberId));
  container.appendChild(btnEvent);
  // Chore quick button
  const btnChore = document.createElement('button');
  btnChore.className = 'mini';
  btnChore.textContent = '+ Chore';
  btnChore.addEventListener('click', ()=>openChoreModal(undefined, memberId, dateKey));
  container.appendChild(btnChore);
  // Groceries quick button
  const btnGro = document.createElement('button');
  btnGro.className = 'mini';
  btnGro.textContent = '+ Grocery';
  btnGro.addEventListener('click', ()=>openListItemModal('groceries'));
  container.appendChild(btnGro);
  // To-Do quick button
  const btnTodo = document.createElement('button');
  btnTodo.className = 'mini';
  btnTodo.textContent = '+ To-Do';
  btnTodo.addEventListener('click', ()=>openListItemModal('todos'));
  container.appendChild(btnTodo);
  // Meal quick button
  const btnMeal = document.createElement('button');
  btnMeal.className = 'mini';
  btnMeal.textContent = '+ Meal';
  btnMeal.addEventListener('click', ()=>openMealModal(dateKey));
  container.appendChild(btnMeal);
  // Recipe quick button
  const btnRecipe = document.createElement('button');
  btnRecipe.className = 'mini';
  btnRecipe.textContent = '+ Recipe';
  btnRecipe.addEventListener('click', ()=>{
    openMealModal(dateKey);
    setTimeout(()=>{ $('#recipeSearch')?.focus(); }, 0);
  });
  container.appendChild(btnRecipe);

  // Custom quick buttons defined by the user
  if(state.customButtons && Array.isArray(state.customButtons)){
    state.customButtons.forEach((btnDef, idx) => {
      const cbtn = document.createElement('button');
      // add custom-btn class so custom buttons can be styled larger on calendar
      cbtn.className = 'mini custom-btn';
      cbtn.textContent = btnDef.label || `Btn ${idx+1}`;
      // Apply custom colour if provided
      if(btnDef.color){
        cbtn.style.background = btnDef.color;
        // set contrasting text colour (simple heuristic: if dark color lighten text)
        try{
          const rgb = parseInt(btnDef.color.replace('#',''), 16);
          const r = (rgb >> 16) & 0xFF;
          const g = (rgb >> 8) & 0xFF;
          const b = rgb & 0xFF;
          const luminance = (0.299*r + 0.587*g + 0.114*b)/255;
          cbtn.style.color = luminance > 0.6 ? '#000' : '#fff';
        } catch(e){ }
      }
      cbtn.addEventListener('click', ()=> handleCustomButtonClick(idx));
      container.appendChild(cbtn);
    });
  }
}

// Handle clicks on custom quick buttons to create an event and advance the selected day
function handleCustomButtonClick(index){
  const btnDef = state.customButtons && state.customButtons[index];
  if(!btnDef || !btnDef.label) return;
  // Determine start and end times as local date strings without timezone conversion.
  // Use per-button startTime/endTime if configured, defaulting to whole-day.
  const dateKey = agendaSelectedKey;
  let startTime = '00:00';
  let endTime = '23:59';
  if(btnDef && btnDef.startTime) startTime = btnDef.startTime;
  if(btnDef && btnDef.endTime) endTime = btnDef.endTime;
  // Build ISO-like strings (without timezone Z) to store local times
  const startStr = `${dateKey}T${startTime}:00`;
  const endStr = `${dateKey}T${endTime}:00`;
  // Determine member: use selected profile if not 'all', else first member
  let memberId = (selectedProfileId && selectedProfileId !== 'all') ? selectedProfileId : (state.members[0]?.id || '');
  // Determine the event title: include member name if a specific profile is selected
  let eventTitle = btnDef.label;
  if(selectedProfileId && selectedProfileId !== 'all'){
    const member = byId(state.members, selectedProfileId);
    if(member && member.name) eventTitle = `${member.name} - ${btnDef.label}`;
  }
  const newEvent = {
    id: uid(),
    title: eventTitle,
    start: startStr,
    end: endStr,
    memberId: memberId,
    location: '',
    notes: '',
    // store the button colour on the event so the pill matches the button
    color: btnDef.color || null
  };
  state.events.push(newEvent);
  saveState();
  // Advance to next day and re-render
  const currentDate = parseDateOnlyLocal(dateKey);
  const next = new Date(currentDate); next.setDate(currentDate.getDate()+1);
  agendaSelectedKey = dateKeyLocal(next);
  renderCalendar();
  // renderCalendar already triggers renderAgenda and renderQuickButtons
}

const eventModal=$('#eventModal');
$('#deleteEventBtn').addEventListener('click', ()=>{
  const id=$('#eventId').value; if(!id) return eventModal.close();
  state.events=state.events.filter(e=>e.id!==id); saveState(); eventModal.close(); renderCalendar();
});
$('#saveEventBtn').addEventListener('click', ()=>{
  const id=$('#eventId').value || uid();
  const payload={
    id,
    title: $('#eventTitle').value.trim(),
    start: fromLocalInput($('#eventStart').value),
    end: fromLocalInput($('#eventEnd').value),
    memberId: $('#eventMember').value,
    location: $('#eventLocation').value.trim(),
    notes: $('#eventNotes').value.trim()
  };
  if(!payload.title) return;
  const exists=state.events.some(e=>e.id===id);
  // preserve custom colour if editing an existing event that has one
  if(exists){
    const prev = byId(state.events, id);
    if(prev && prev.color) payload.color = prev.color;
  }
  state.events = exists ? state.events.map(e=>e.id===id?payload:e) : [...state.events,payload];
  saveState(); eventModal.close(); renderCalendar();
});
// Modify openEventModal to accept optional dateKey and memberId
function openEventModal(eventId, dateKey, memberId){
  $('#eventModalTitle').textContent = eventId?'Edit Event':'New Event';
  const sel=$('#eventMember'); sel.innerHTML=state.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  if(eventId){
    const e=byId(state.events,eventId);
    $('#eventId').value=e.id; $('#eventTitle').value=e.title;
    $('#eventStart').value=toLocalInput(e.start); $('#eventEnd').value=toLocalInput(e.end);
    $('#eventMember').value=e.memberId; $('#eventLocation').value=e.location||''; $('#eventNotes').value=e.notes||''; 
    $('#deleteEventBtn').style.display='inline-block';
  } else {
    $('#eventId').value=''; $('#eventTitle').value='';
    const start = dateKey ? parseDateOnlyLocal(dateKey) : new Date(); if (dateKey) start.setHours(9,0,0,0);
    const end=new Date(start); end.setHours(end.getHours()+1);
    $('#eventStart').value=toLocalInput(start.toISOString()); $('#eventEnd').value=toLocalInput(end.toISOString());
    // set member based on parameter or selected profile
    let defaultMember = memberId && memberId !== 'all' ? memberId : (state.members[0]?.id ?? '');
    $('#eventMember').value=defaultMember;
    $('#eventLocation').value=''; $('#eventNotes').value='';
    $('#deleteEventBtn').style.display='none';
  }
  eventModal.showModal();
}

$('#addChoreBtn').addEventListener('click', ()=>openChoreModal(undefined, selectedProfileId, agendaSelectedKey));
const choreModal=$('#choreModal');
$('#saveChoreBtn').addEventListener('click', ()=>{
  const id=$('#choreId').value || uid();
  const payload={ id,
    title: $('#choreTitle').value.trim(),
    assignee: $('#choreAssignee').value,
    due: $('#choreDue').value || null,
    repeat: $('#choreRepeat').value,
    done: false
  };
  if(!payload.title){ alert('Please enter a title'); return; }
  const exists=state.chores.some(c=>c.id===id);
  if(exists){ const prev=byId(state.chores,id); payload.done=prev.done; state.chores=state.chores.map(c=>c.id===id?payload:c); }
  else state.chores.push(payload);
  saveState(); choreModal.close(); renderChores(); renderCalendar();
});
$('#deleteChoreBtn').addEventListener('click', ()=>{
  const id=$('#choreId').value; if(!id) return choreModal.close();
  state.chores=state.chores.filter(c=>c.id!==id); saveState(); choreModal.close(); renderChores(); renderCalendar();
});
// modify openChoreModal to accept optional memberId and dateKey for prefill
function openChoreModal(choreId, memberId, dateKey){
  const sel=$('#choreAssignee'); sel.innerHTML=state.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  if(choreId){
    const c=byId(state.chores,choreId);
    $('#choreModalTitle').textContent='Edit Chore';
    $('#choreId').value=c.id; $('#choreTitle').value=c.title; $('#choreAssignee').value=c.assignee;
    $('#choreDue').value=c.due||''; $('#choreRepeat').value=c.repeat||'none';
    $('#deleteChoreBtn').style.display='inline-block';
  } else {
    $('#choreModalTitle').textContent='New Chore';
    $('#choreId').value=''; $('#choreTitle').value='';
    // prefill assignee with provided member or selected profile
    let defaultAssignee = memberId && memberId !== 'all' ? memberId : (state.members[0]?.id ?? '');
    $('#choreAssignee').value=defaultAssignee;
    $('#choreDue').value=dateKey || '';
    $('#choreRepeat').value='none';
    $('#deleteChoreBtn').style.display='none';
  }
  choreModal.showModal();
}
function renderChores(){
  const assigneeFilter=$('#choreAssigneeFilter');
  assigneeFilter.innerHTML='<option value="all">Anyone</option>'+state.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  // keep filter in sync with selected profile
  assigneeFilter.value = selectedProfileId || 'all';
  assigneeFilter.onchange = () => {
    // update selected profile when assignee filter changes
    selectedProfileId = assigneeFilter.value;
    // sync calendar member filter
    const memberFilter = $('#memberFilter');
    if(memberFilter) memberFilter.value = selectedProfileId;
    renderCalendar();
    renderAgenda();
    renderProfilePills();
    renderQuickButtons();
    renderChores();
    highlightMemberChips();
  };
  const statusFilter=$('#choreStatusFilter'); statusFilter.onchange = () => {
    renderChores();
  };

  const ul=$('#choreList'); ul.innerHTML='';
  const today=atMidnight(new Date());
  state.chores
    .filter(c=>assigneeFilter.value==='all'?true:c.assignee===assigneeFilter.value)
    .filter(c=>statusFilter.value==='all'?true:(statusFilter.value==='done'?c.done:!c.done))
    .sort((a,b)=>(a.due||'9999-99-99').localeCompare(b.due||'9999-99-99'))
    .forEach(c=>{
      const li=document.createElement('li'); li.className='card';
      const m=byId(state.members,c.assignee); const color=m?.color||'#999';
      const dueText=c.due?parseDateOnlyLocal(c.due).toLocaleDateString():'No due date';
      const overdue=c.due && parseDateOnlyLocal(c.due) < today && !c.done;
      li.innerHTML=`
        <div class="row space-between align-center wrap">
          <div class="row align-center gap wrap">
            <input class="chore-check" type="checkbox" ${c.done?'checked':''} aria-label="Done" />
            <strong class="chore-title">${escapeHtml(c.title)}</strong>
            <span class="member-chip" data-member-id="${c.assignee}" title="${m?.name||'Unassigned'}"><span class="dot" style="background:${color};width:.8rem;height:.8rem;border-radius:50%"></span>${m?.name||'â€”'}</span>
          </div>
          <span ${overdue?'style="color:var(--danger);font-weight:600"':'class="muted"'}>${dueText}</span>
        </div>
        <div class="row space-between wrap">
          <div class="muted">Repeats: ${c.repeat}</div>
          <div class="row gap">
            <button class="secondary edit">Edit</button>
            <button class="danger delete">Delete</button>
          </div>
        </div>`;
      if (c.done) li.classList.add('completed');
      const checkbox = li.querySelector('.chore-check');
      const titleEl = li.querySelector('.chore-title');
      if (c.done) titleEl.classList.add('strike');
      checkbox.addEventListener('change', (ev)=>{
        const rect = ev.target.getBoundingClientRect();
        if (!c.done) confettiBurst(rect.left+8, rect.top+8);
        c.done = checkbox.checked;
        titleEl.classList.toggle('strike', c.done);
        li.classList.toggle('completed', c.done);
        titleEl.classList.add('done-pop'); setTimeout(()=>titleEl.classList.remove('done-pop'), 250);
        if(c.done && c.repeat!=='none' && c.due){
          // Create the next occurrence of a repeating chore when marked done.
          // Use different logic depending on repeat frequency.
          if(c.repeat==='daily' || c.repeat==='weekly'){
            const d=parseDateOnlyLocal(c.due);
            if(c.repeat==='daily') d.setDate(d.getDate()+1);
            if(c.repeat==='weekly') d.setDate(d.getDate()+7);
            state.chores.push({ ...c, id: uid(), done:false, due: dateKeyLocal(d) });
          } else if(c.repeat==='monthly'){
            // For monthly repeats, schedule on the same day next month (or last day if the next month has fewer days).
            const prevDate = parseDateOnlyLocal(c.due);
            let year = prevDate.getFullYear();
            let month = prevDate.getMonth() + 1; // target month is current month + 1
            let day = prevDate.getDate();
            // Construct candidate date. JavaScript Date will adjust year overflow automatically.
            let candidate = new Date(year, month, day);
            // If the month overflows (i.e., candidate's month is not equal to target month modulo 12), adjust to last day of target month.
            if(candidate.getMonth() !== (month % 12)){
              // Last day of target month: create a date on the 0th day of the following month.
              candidate = new Date(year, month + 1, 0);
            }
            state.chores.push({ ...c, id: uid(), done:false, due: dateKeyLocal(candidate) });
          } else if(c.repeat==='yearly'){
            // For yearly repeats, schedule on the same month and day next year (or last day if February 29 in a non-leap year).
            const prevDate = parseDateOnlyLocal(c.due);
            let year = prevDate.getFullYear() + 1;
            let month = prevDate.getMonth();
            let day = prevDate.getDate();
            let candidate = new Date(year, month, day);
            if(candidate.getMonth() !== month){
              // Adjust to last day of the target month if the day does not exist in the new year (e.g. Feb 29).
              candidate = new Date(year, month + 1, 0);
            }
            state.chores.push({ ...c, id: uid(), done:false, due: dateKeyLocal(candidate) });
          }
        }
        saveState(); renderChores(); renderCalendar();
      });
      // Click to select this member
      const chip = li.querySelector('.member-chip');
      chip.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        selectedProfileId = c.assignee;
        const memberFilter = $('#memberFilter');
        if(memberFilter) memberFilter.value = selectedProfileId;
        renderCalendar(); renderAgenda(); renderProfilePills(); renderQuickButtons(); highlightMemberChips();
      });
      li.querySelector('.edit').addEventListener('click', ()=>openChoreModal(c.id));
      li.querySelector('.delete').addEventListener('click', ()=>{ state.chores=state.chores.filter(x=>x.id!==c.id); saveState(); renderChores(); renderCalendar(); });
      ul.appendChild(li);
    });
  highlightMemberChips();
  // update profile pills within chores
  renderProfilePills();
}

$$('.addListItemBtn').forEach(btn=> btn.addEventListener('click', ()=>openListItemModal(btn.dataset.list)) );
const listModal=$('#listItemModal');
$('#saveListItemBtn').addEventListener('click', ()=>{
  const type=$('#listType').value; const id=$('#listItemId').value || uid();
  const payload={ id, text:$('#listItemText').value.trim(), qty:$('#listItemQty').value.trim(), done:false };
  if(!payload.text) return;
  const exists=state.lists[type].some(i=>i.id===id);
  if(exists){ const prev=state.lists[type].find(i=>i.id===id); payload.done=prev.done; state.lists[type]=state.lists[type].map(i=>i.id===id?payload:i); }
  else state.lists[type].push(payload);
  saveState(); listModal.close(); renderLists();
});
$('#deleteListItemBtn').addEventListener('click', ()=>{
  const type=$('#listType').value; const id=$('#listItemId').value; if(!id) return listModal.close();
  state.lists[type]=state.lists[type].filter(i=>i.id!==id); saveState(); listModal.close(); renderLists();
});
function openListItemModal(type, itemId){
  $('#listType').value=type;
  if(itemId){
    const it=state.lists[type].find(i=>i.id===itemId);
    $('#listItemModalTitle').textContent='Edit Item'; $('#listItemId').value=it.id; $('#listItemText').value=it.text; $('#listItemQty').value=it.qty||''; $('#deleteListItemBtn').style.display='inline-block';
  } else {
    $('#listItemModalTitle').textContent='New Item'; $('#listItemId').value=''; $('#listItemText').value=''; $('#listItemQty').value=''; $('#deleteListItemBtn').style.display='none';
  }
  listModal.showModal();
}
function renderLists(){
  ['groceries','todos'].forEach(type=>{
    const ul= type==='groceries' ? $('#groceriesList') : $('#todosList'); ul.innerHTML='';
    state.lists[type].forEach(it=>{
      const li=document.createElement('li'); li.className='card';
      li.innerHTML=`<div class="row space-between align-center wrap">
        <div class="row align-center gap wrap">
          <input type="checkbox" ${it.done?'checked':''} />
          <strong class="item-title">${escapeHtml(it.text)}</strong> ${it.qty?`<span class="muted">(${escapeHtml(it.qty)})</span>`:''}
        </div>
        <div class="row gap"><button class="secondary edit">Edit</button><button class="danger delete">Delete</button></div>
      </div>`;
      const title=li.querySelector('.item-title');
      if(it.done){ title.classList.add('strike'); li.classList.add('completed'); }
      li.querySelector('input').addEventListener('change', (ev)=>{
        it.done=!it.done;
        title.classList.toggle('strike', it.done);
        li.classList.toggle('completed', it.done);
        if(it.done){
          const rect = ev.target.getBoundingClientRect();
          confettiBurst(rect.left+8, rect.top+8);
          title.classList.add('done-pop'); setTimeout(()=>title.classList.remove('done-pop'), 250);
        }
        saveState();
      });
      li.querySelector('.edit').addEventListener('click', ()=>openListItemModal(type, it.id));
      li.querySelector('.delete').addEventListener('click', ()=>{ state.lists[type]=state.lists[type].filter(x=>x.id!==it.id); saveState(); renderLists(); });
      ul.appendChild(li);
    });
  });
}

let weekCursor = startOfWeek(new Date());
$('#prevWeek').addEventListener('click', ()=>{ weekCursor.setDate(weekCursor.getDate()-7); renderMeals(); });
$('#nextWeek').addEventListener('click', ()=>{ weekCursor.setDate(weekCursor.getDate()+7); renderMeals(); });
$('#addMealBtn').addEventListener('click', ()=>openMealModal(dateKeyLocal(weekCursor)));
$('#sendIngredientsBtn').addEventListener('click', sendIngredientsToGroceries);

const mealModal=$('#mealModal');
$('#saveMealBtn').addEventListener('click', ()=>{
  const date=$('#mealDate').value; const slot=$('#mealSlot').value; const name=$('#mealName').value.trim();
  const ingredients=$('#mealIngredients').value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!date||!slot||!name) return;
  const wkKey=dateKeyLocal(startOfWeek(parseDateOnlyLocal(date)));
  if(!state.meals[wkKey]) state.meals[wkKey]={};
  if(!state.meals[wkKey][date]) state.meals[wkKey][date]={};
  state.meals[wkKey][date][slot]={ name, ingredients };
  // bump usage if name matches a recipe
  const recipe = state.recipes.find(r => r.name.toLowerCase() === name.toLowerCase());
  if(recipe){
    state.recipeUsage[recipe.id] = (state.recipeUsage[recipe.id]||0) + 1;
  }
  saveState(); mealModal.close(); renderMeals();
});
$('#deleteMealBtn').addEventListener('click', ()=>{
  const date=$('#mealDate').value; const slot=$('#mealSlot').value;
  const wkKey=dateKeyLocal(startOfWeek(parseDateOnlyLocal(date)));
  if(state.meals[wkKey]?.[date]?.[slot]){ delete state.meals[wkKey][date][slot]; saveState(); }
  mealModal.close(); renderMeals();
});
function openMealModal(dateKey, slot='Dinner'){
  $('#mealModalTitle').textContent='Add Meal';
  $('#mealDate').value=dateKey; $('#mealSlot').value=slot;
  populateRecipesUI();
  const wkKey=dateKeyLocal(startOfWeek(parseDateOnlyLocal(dateKey)));
  const existing=state.meals[wkKey]?.[dateKey]?.[slot];
  $('#mealName').value=existing?.name||''; $('#mealIngredients').value=existing?.ingredients?.join(', ')||'';
  mealModal.showModal();
}
function renderMeals(){
  const start=startOfWeek(weekCursor); const end=endOfWeek(weekCursor);
  $('#weekLabel').textContent = `${start.toLocaleDateString()} â€“ ${end.toLocaleDateString()}`;
  const grid=$('#mealGrid'); grid.innerHTML=''; const wkKey=dateKeyLocal(startOfWeek(weekCursor)); const slots=['Breakfast','Lunch','Dinner'];
  for(let i=0;i<7;i++){
    const d=new Date(start); d.setDate(start.getDate()+i); const key=dateKeyLocal(d);
    const day=document.createElement('div'); day.className='meal-day';
    day.innerHTML=`<header><div>${d.toLocaleDateString(undefined,{weekday:'short',day:'numeric',month:'short'})}</div>
      <div class="quick">
        <button class="secondary mini" data-from-recipe="${key}">+ From recipe</button>
        <button class="secondary mini" data-date="${key}">+ Add</button>
      </div>
    </header>`;
    day.querySelector('button[data-date]').addEventListener('click', ()=>openMealModal(key));
    day.querySelector('button[data-from-recipe]').addEventListener('click', ()=>{
      openMealModal(key);
      $('#recipeSearch').focus();
    });
    slots.forEach(slot=>{
      const slotDiv=document.createElement('div'); slotDiv.className='meal-slot';
      const existing=state.meals[wkKey]?.[key]?.[slot];
      if(existing){
        slotDiv.innerHTML=`<h4>${slot}: ${escapeHtml(existing.name)}</h4><div class="ingredients">${existing.ingredients.join(', ')}</div><div class="row gap"><button class="secondary edit">Edit</button><button class="danger clear">Clear</button></div>`;
        slotDiv.querySelector('.edit').addEventListener('click', ()=>openMealModal(key,slot));
        slotDiv.querySelector('.clear').addEventListener('click', ()=>{ delete state.meals[wkKey][key][slot]; saveState(); renderMeals(); });
      } else {
        slotDiv.innerHTML=`<h4>${slot}</h4><div class="muted">â€”</div>`;
      }
      slotDiv.addEventListener('dblclick', ()=>openMealModal(key, slot));
      slotDiv.addEventListener('click', (e)=>{
        // quick fill dinner on single click if empty and top recipe exists
        if(!existing && slot==='Dinner' && state.recipes.length && e.target.tagName!=='BUTTON'){
          openMealModal(key, slot);
        }
      });
      day.appendChild(slotDiv);
    });
    grid.appendChild(day);
  }
}

/* ==== Recipes UI helpers ==== */
function populateRecipesUI(){
  // dropdown
  const sel = $('#recipeSelect');
  sel.innerHTML = '<option value="">â€” Choose a recipe â€”</option>' +
    state.recipes.map(r => `<option value="${r.id}">${escapeHtml(r.name)}</option>`).join('');
  sel.onchange = () => {
    const r = byId(state.recipes, sel.value);
    if(!r) return;
    $('#mealName').value = r.name;
    $('#mealIngredients').value = r.ingredients.join(', ');
  };

  // search + grid
  const search = $('#recipeSearch');
  const grid = $('#topRecipes');
  function usageCount(r){ return state.recipeUsage[r.id] || 0; }
  function renderGrid(){
    const q = (search.value||'').toLowerCase();
    const list = state.recipes
      .slice()
      .sort((a,b)=> usageCount(b) - usageCount(a) || a.name.localeCompare(b.name))
      .filter(r => !q || r.name.toLowerCase().includes(q) || r.ingredients.join(',').toLowerCase().includes(q))
      .slice(0, 24); // keep it brisk
    grid.innerHTML = list.map(r => 
      `<div class="recipe-chip" data-id="${r.id}" title="${escapeHtml(r.ingredients.join(', '))}">
         <span>${escapeHtml(r.name)}</span>
         <small>â˜… ${usageCount(r)}</small>
       </div>`
    ).join('');
    grid.querySelectorAll('.recipe-chip').forEach(chip => {
      chip.addEventListener('click', ()=>{
        const r = byId(state.recipes, chip.dataset.id);
        if(!r) return;
        $('#recipeSelect').value = r.id;
        $('#mealName').value = r.name;
        $('#mealIngredients').value = r.ingredients.join(', ');
      });
    });
  }
  search.oninput = renderGrid;
  renderGrid();
}

function sendIngredientsToGroceries(){
  const wkKey=dateKeyLocal(startOfWeek(weekCursor)); const days=state.meals[wkKey]||{}; const items=[];
  Object.values(days).forEach(day=>{ ['Breakfast','Lunch','Dinner'].forEach(slot=>{ const m=day[slot]; if(m?.ingredients?.length) items.push(...m.ingredients); }); });
  const unique=[...new Set(items.map(s=>s.toLowerCase().trim()))];
  unique.forEach(text=> state.lists.groceries.push({ id: uid(), text, qty:'', done:false }) );
  saveState(); alert('Ingredients added to Groceries!'); renderLists();
}

function renderSettings(){
  const ul=$('#memberList'); ul.innerHTML='';
  state.members.forEach(m=>{
    const li=document.createElement('li'); li.className='member-row';
    li.innerHTML=`<span class="member-chip" data-member-id="${m.id}"><span class="dot" style="background:${m.color};width:.8rem;height:.8rem;border-radius:50%"></span>${escapeHtml(m.name)}</span>
      <input type="color" value="${m.color}" aria-label="Color for ${m.name}" />
      <button class="secondary rename">Rename</button>
      <button class="danger remove">Remove</button>`;
    li.querySelector('input[type="color"]').addEventListener('input', e=>{ m.color=e.target.value; saveState(); renderCalendar(); renderChores(); renderProfilePills(); renderQuickButtons(); });
    li.querySelector('.rename').addEventListener('click', ()=>{ const name=prompt('New name', m.name); if(name){ m.name=name; saveState(); renderSettings(); renderCalendar(); renderChores(); renderProfilePills(); renderQuickButtons(); } });
    li.querySelector('.remove').addEventListener('click', ()=>{ if(!confirm('Remove member? Events/chores will remain with this member ID.')) return; state.members=state.members.filter(x=>x.id!==m.id); saveState(); renderSettings(); renderCalendar(); renderChores(); renderProfilePills(); renderQuickButtons(); });
    ul.appendChild(li);
  });
  $('#addMemberBtn').onclick=()=>{ const name=prompt('Member name'); if(!name) return; state.members.push({ id: uid(), name, color:'#f59e0b' }); saveState(); renderSettings(); renderCalendar(); renderChores(); renderProfilePills(); renderQuickButtons(); };
  $$('.themeBtn').forEach(btn=> btn.onclick=()=>{ state.settings.theme=btn.dataset.theme; saveState(); ensureTheme(); });
  $('#exportJsonBtn').onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); downloadBlob(blob,'family-command-center.json'); };
  $('#importJsonInput').onchange=async (e)=>{ const f=e.target.files[0]; if(!f) return; try{ const imported=JSON.parse(await f.text()); state=imported; saveState(); ensureTheme(); renderCalendar(); renderChores(); renderLists(); renderMeals(); renderSettings(); renderProfilePills(); renderQuickButtons(); alert('Import successful!'); }catch(err){ alert('Import failed: '+err.message); } };
  $('#exportIcsBtn').onclick=()=>{ const ics=buildICS(state.events); const blob=new Blob([ics],{type:'text/calendar'}); downloadBlob(blob,'family-events.ics'); };

  // Recipes panel
  const list = $('#recipeList');
  if(list){
    list.innerHTML='';
    state.recipes.forEach(r=>{
      const li=document.createElement('li'); li.className='card';
      const count = state.recipeUsage[r.id] || 0;
      li.innerHTML = `<div class="row space-between align-center wrap">
          <strong>${escapeHtml(r.name)}</strong>
          <div class="row gap">
            <span class="muted">â˜… ${count}</span>
            <button class="secondary edit">Edit</button>
            <button class="danger delete">Delete</button>
          </div>
        </div>
        <div class="muted">${escapeHtml(r.ingredients.join(', '))}</div>`;
      li.querySelector('.edit').addEventListener('click', ()=>{
        const name=prompt('Recipe name', r.name); if(!name) return;
        const ing=prompt('Ingredients (comma separated)', r.ingredients.join(', '));
        if(ing===null) return;
        r.name = name.trim();
        r.ingredients = ing.split(',').map(s=>s.trim()).filter(Boolean);
        saveState(); renderSettings();
      });
      li.querySelector('.delete').addEventListener('click', ()=>{
        if(!confirm('Delete recipe?')) return;
        delete state.recipeUsage[r.id];
        state.recipes = state.recipes.filter(x=>x.id !== r.id);
        saveState(); renderSettings();
      });
      list.appendChild(li);
    });
    $('#addRecipeBtn')?.addEventListener('click', ()=>{
      const name=prompt('Recipe name'); if(!name) return;
      const ing=prompt('Ingredients (comma separated)','');
      const ingredients=(ing||'').split(',').map(s=>s.trim()).filter(Boolean);
      const id = uid();
      state.recipes.push({ id, name: name.trim(), ingredients });
      state.recipeUsage[id] = 0;
      saveState(); renderSettings();
    });
  }

  // Quick Buttons customisation panel
  const customList = document.getElementById('customButtonsList');
  if(customList){
    customList.innerHTML = '';
    // Ensure the array exists
    if(!Array.isArray(state.customButtons)) state.customButtons = defaultData().customButtons;
    state.customButtons.forEach((btnDef, idx) => {
      const row = document.createElement('div');
      row.className = 'custom-row';
      row.innerHTML = `
        <label>Label <input type="text" data-index="${idx}" value="${escapeHtml(btnDef.label||'')}" /></label>
        <label>Colour <input type="color" data-index="${idx}" value="${btnDef.color||'#ffffff'}" /></label>
        <label>Start <input type="time" data-index="${idx}" data-field="startTime" value="${btnDef.startTime||'00:00'}" /></label>
        <label>End <input type="time" data-index="${idx}" data-field="endTime" value="${btnDef.endTime||'23:59'}" /></label>
        <button class="danger mini remove-btn" data-index="${idx}" title="Remove">Remove</button>
      `;
      customList.appendChild(row);
    });
    // Attach change listeners for labels
    customList.querySelectorAll('input[type="text"]').forEach(inp => {
      inp.addEventListener('input', (ev) => {
        const index = parseInt(ev.target.getAttribute('data-index')); 
        state.customButtons[index].label = ev.target.value;
        saveState();
        renderQuickButtons();
      });
    });
    // Attach change listeners for colours
    customList.querySelectorAll('input[type="color"]').forEach(inp => {
      inp.addEventListener('input', (ev) => {
        const index = parseInt(ev.target.getAttribute('data-index'));
        state.customButtons[index].color = ev.target.value;
        saveState();
        renderQuickButtons();
      });
    });
    // Attach change listeners for start/end times
    customList.querySelectorAll('input[type="time"]').forEach(inp => {
      inp.addEventListener('input', (ev) => {
        const index = parseInt(ev.target.getAttribute('data-index'));
        const field = ev.target.getAttribute('data-field');
        state.customButtons[index][field] = ev.target.value;
        saveState();
        renderQuickButtons();
      });
    });
    // Attach remove button listeners
    customList.querySelectorAll('.remove-btn').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        const index = parseInt(ev.target.getAttribute('data-index'));
        state.customButtons.splice(index, 1);
        saveState();
        renderSettings();
        renderQuickButtons();
      });
    });
    // Add button to append a new custom quick button
    const addBtn = document.createElement('button');
    addBtn.className = 'secondary mini';
    addBtn.textContent = '+ Add Button';
    addBtn.addEventListener('click', () => {
      // push a new default button definition
      state.customButtons.push({ label: '', color: '#ffffff', startTime: '00:00', endTime: '23:59' });
      saveState();
      renderSettings();
      renderQuickButtons();
    });
    customList.appendChild(addBtn);
  }
}
function buildICS(events){
  const dtstamp=new Date().toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Family Command Center//EN'];
  events.forEach(e=>{
    const dtStart=new Date(e.start).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
    const dtEnd=new Date(e.end).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
    const m=byId(state.members,e.memberId);
    lines.push('BEGIN:VEVENT','UID:'+e.id+'@fcc','DTSTAMP:'+dtstamp,'DTSTART:'+dtStart,'DTEND:'+dtEnd,'SUMMARY:'+icsEscape((m?`[${m.name}] `:'')+e.title));
    if(e.location) lines.push('LOCATION:'+icsEscape(e.location));
    if(e.notes) lines.push('DESCRIPTION:'+icsEscape(e.notes));
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR'); return lines.join('\r\n');
}
function icsEscape(s){ return s.replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;'); }
function downloadBlob(blob, filename){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); }

async function boot(){
  // Load state (from Firestore if available) before rendering
  await loadState();
  ensureTheme();
  agendaSelectedKey = dateKeyLocal(new Date());
  renderCalendar(); renderChores(); renderLists(); renderMeals(); renderSettings(); renderProfilePills(); renderQuickButtons();
  setActive('meals'); // jump straight to meals for convenience
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
